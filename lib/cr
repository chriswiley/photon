
namespace eval :: {

set cr_pending { }
set cr_sock ""

proc cr_newdata { sock } {
  variable cr_sock
  if { [ eof $sock ] } {
    variable cr_sock
    close $cr_sock
    cr_reconnect
    return -code ok
  }
  if { [ catch [ list cr_readdata $sock ] stuff ]} {
    ::warninglog "cr_readdata failed $stuff"
  }
  return -code ok
}

proc cr_setsync { sync } {
  variable cr_sock
  cr_sputs $cr_sock "SETSYNC $sync"
  cr_sflush $cr_sock
}

proc cr_read { } {
  variable cr_sock
  variable cr_pending
  set cr_returned $cr_pending
  set cr_pending { }
  return $cr_returned
}

proc cr_write { byte } {
  variable cr_sock
  cr_sputs $cr_sock "WRITE $byte"
  cr_sflush $cr_sock
}

proc cr_enable { on } {
  variable cr_sock

  set mode "OFF"
  if { "$on" == "1" } {
    set mode "ON"
  }
  cr_sputs $cr_sock "ENABLE ON"
  cr_sputs $cr_sock "READ ON"
  cr_sflush $cr_sock
}

proc cr_readdata { sock } {
  variable cr_sock
  variable cr_pending
  
  if { [ eof $sock ] } {
    return -code ok
  }

  if { [ gets $sock line ] < 0 } {
  } else {
    set line [ string trim $line "\r\n" ]
    set e [ split $line {} ]
    set code [ join [ lrange $e 0 2 ] "" ]
    set message [ join [ lrange $e 4 end ] "" ]
    set stuff [ split $message " " ]

    if { $code == 905 } {
      lappend cr_pending "$message"
    } elseif { $code == 999 } {
      ::warninglog "$message"
    }
  }
  
  if { [ catch [ list ::Photon::cr_handler ] stuff ] } {
    ::warninglog "cr_handler failed $stuff"
  }

  return -code ok
}

proc cr_sputs { sock message } {
  if { [ catch [ list puts $sock $message ] stuff ] } {
    ::warninglog "write error to socket $sock ($stuff)"
  }
}

proc cr_sflush { sock } {  
  if { [ catch [ flush $sock ] stuff ] } {
    ::warninglog "flush error to socket $sock ($stuff)"
  }
}   

proc cr_init { } {
  variable cr_sock
  cr_reconnect
}

proc cr_reconnect { } {
  variable cr_sock

  if {[info exists ::Conf::cr_tty ]} {
    ::warninglog "Opening radio at $::Conf::cr_tty"
    set rc [ catch "open $::Conf::cr_tty RDWR" s ]
  } else {
    ::warninglog "Opening radio at $::Conf::cr_server_name $::Conf::cr_listenport"
    set rc [ catch "socket $::Conf::cr_server_name $::Conf::cr_listenport" s ]
  }

  if { $rc != 0 } {
    ::warninglog "Failed to open CR connection... sleeping"
    ::warninglog $s
    after 1000 cr_reconnect
    return -code ok
  }

  fconfigure $s -buffering line
  fconfigure $s -blocking 0
  fconfigure $s -mode 115200,n,8,1
  fconfigure $s -translation binary
  fconfigure $s -eofchar {}

  set rc [ catch {
    puts $s "ENABLE ON"
    puts $s "READ ON"
    flush $s
  } stuff ]
  if { $rc != 0 } {
    ::warninglog "error initializing cr $stuff"
  }

  fileevent $s readable [ list ::cr_newdata $s ]

  set cr_sock $s
}

}
